<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Listen Together â€“ YouTube</title>
  <link rel="stylesheet" href="/style.css" />
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://www.youtube.com/iframe_api"></script>
</head>
<body>
  <div class="card">
    <h1>ðŸŽ§ Listen Together â€“ YouTube</h1>

    <section id="room-controls">
      <div class="row">
        <button id="create-room">Create Room</button>
        <span class="or-text">or join existing room:</span>
        <input id="room-id-input" type="text" placeholder="Enter room ID" />
        <button id="join-room">Join Room</button>
      </div>
      <p id="status"></p>
    </section>

    <section id="room-actions" class="hidden">
      <p class="room-label">Room ID: <span id="current-room"></span></p>
      <div class="row">
        <input id="video-input" type="text" placeholder="YouTube URL or ID" />
        <button id="set-video">Set Video for Room</button>
        <button id="skip-video" class="secondary">Skip</button>
      </div>
      <div id="player" class="player"></div>
      <p class="note">When anyone in this room presses Play/Pause/Seek (or Skip), all players stay in sync.</p>
    </section>
  </div>

  <script>
    const socket = io();
    let player;
    let currentRoomId = null;
    let isSyncingFromServer = false;
    let lastKnownTime = 0;

    const statusEl = document.getElementById('status');
    const roomSection = document.getElementById('room-actions');
    const roomLabel = document.getElementById('current-room');
    const videoInput = document.getElementById('video-input');
    const roomInput = document.getElementById('room-id-input');
    const skipBtn = document.getElementById('skip-video');

    const setStatus = (text, isError = false) => {
      statusEl.textContent = text || '';
      statusEl.className = isError ? 'error' : 'success';
    };

    const parseVideoId = (value) => {
      if (!value) return null;
      const urlPattern = /(?:youtube\.com\/(?:.*v=|embed\/)|youtu\.be\/)([\w-]{11})/;
      const match = value.match(urlPattern);
      if (match && match[1]) return match[1];
      if (/^[\w-]{11}$/.test(value)) return value;
      return null;
    };

    document.getElementById('create-room').addEventListener('click', () => {
      socket.emit('create-room', ({ roomId, state }) => {
        currentRoomId = roomId;
        roomLabel.textContent = roomId;
        roomSection.classList.remove('hidden');
        applyState(state);
        setStatus(`Created room ${roomId}`);
      });
    });

    document.getElementById('join-room').addEventListener('click', () => {
      const roomId = roomInput.value.trim();
      socket.emit('join-room', { roomId }, (res) => {
        if (res.error) {
          setStatus(res.error, true);
          return;
        }
        currentRoomId = res.roomId;
        roomLabel.textContent = res.roomId;
        roomSection.classList.remove('hidden');
        applyState(res.state);
        setStatus(`Joined room ${res.roomId}`);
      });
    });

    document.getElementById('set-video').addEventListener('click', () => {
      const videoId = parseVideoId(videoInput.value.trim());
      if (!videoId) {
        setStatus('Please enter a valid YouTube URL or ID.', true);
        return;
      }
      if (!currentRoomId) {
        setStatus('Join or create a room first.', true);
        return;
      }
      socket.emit('set-video', { roomId: currentRoomId, videoId });
      setStatus(`Loading video ${videoId} for room ${currentRoomId}`);
    });

    skipBtn.addEventListener('click', () => {
      if (!currentRoomId) {
        setStatus('Join or create a room first.', true);
        return;
      }
      socket.emit('player-action', { roomId: currentRoomId, action: 'skip', currentTime: 0 });
      if (player) {
        player.stopVideo();
      }
      lastKnownTime = 0;
      setStatus('Skipped current video. Set a new link to continue.');
    });

    socket.on('load-video', ({ videoId, currentTime }) => {
      if (!player) return;
      isSyncingFromServer = true;
      player.loadVideoById({ videoId, startSeconds: currentTime || 0 });
      lastKnownTime = currentTime || 0;
      setTimeout(() => { isSyncingFromServer = false; }, 500);
    });

    socket.on('sync', ({ action, currentTime }) => {
      if (!player) return;
      isSyncingFromServer = true;
      if (action === 'skip') {
        player.stopVideo();
        lastKnownTime = 0;
        setStatus('Video was skipped. Paste a new link to keep listening.');
        setTimeout(() => { isSyncingFromServer = false; }, 300);
        return;
      }
      const localTime = player.getCurrentTime();
      if (Math.abs(localTime - currentTime) > 0.5) {
        player.seekTo(currentTime, true);
      }
      if (action === 'play') player.playVideo();
      if (action === 'pause') player.pauseVideo();
      if (action === 'seek') player.seekTo(currentTime, true);
      lastKnownTime = currentTime;
      setTimeout(() => { isSyncingFromServer = false; }, 500);
    });

    const onPlayerReady = () => {
      setStatus('YouTube player ready.');
    };

    const onPlayerStateChange = (event) => {
      if (!currentRoomId || isSyncingFromServer || !player) return;
      const currentTime = player.getCurrentTime();
      if (event.data === YT.PlayerState.PLAYING) {
        socket.emit('player-action', { roomId: currentRoomId, action: 'play', currentTime });
        lastKnownTime = currentTime;
      } else if (event.data === YT.PlayerState.PAUSED) {
        socket.emit('player-action', { roomId: currentRoomId, action: 'pause', currentTime });
        lastKnownTime = currentTime;
      } else if (event.data === YT.PlayerState.BUFFERING) {
        if (Math.abs(currentTime - lastKnownTime) > 0.5) {
          socket.emit('player-action', { roomId: currentRoomId, action: 'seek', currentTime });
          lastKnownTime = currentTime;
        }
      }
    };

    function onYouTubeIframeAPIReady() {
      player = new YT.Player('player', {
        height: '315',
        width: '560',
        videoId: '',
        events: {
          onReady: onPlayerReady,
          onStateChange: onPlayerStateChange,
          onError: (event) => {
            setStatus('Video unavailable or blocked. Try another link or press Skip.', true);
          },
        },
      });
    }
    window.onYouTubeIframeAPIReady = onYouTubeIframeAPIReady;

    const applyState = (state) => {
      if (!player || !state) return;
      if (state.videoId) {
        isSyncingFromServer = true;
        player.loadVideoById({ videoId: state.videoId, startSeconds: state.currentTime || 0 });
        lastKnownTime = state.currentTime || 0;
        setTimeout(() => {
          if (state.isPlaying) player.playVideo();
          else player.pauseVideo();
          isSyncingFromServer = false;
        }, 500);
      } else {
        player.stopVideo();
        lastKnownTime = 0;
      }
    };
  </script>
</body>
</html>
